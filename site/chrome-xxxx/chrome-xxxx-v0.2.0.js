!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.ChromeXxxx={})}(this,function(e){"use strict";const t="kc-one",n="kc-table",s="kc-keyconfig";function i({key:e,shiftKey:t,ctrlKey:n,altKey:s,metaKey:i},r){const o=/^[a-z]$/.test(e)?e.toUpperCase():e;r.altKey=s,r.ctrlKey=n,r.key=o,r.metaKey=i,r.shiftKey=t}function r(e){return Object.assign({altKey:!1,ctrlKey:!1,key:"",metaKey:!1,shiftKey:!1},e)}function o(e,t){const n=t.map(({id:e})=>e);return e.get(n).then(e=>{const n={};for(const{id:s,default:i}of t){const t=e[s]||r(i||{});n[s]=t}return n})}const l=new WeakMap;function a(e,...t){const n=l.get(e);if(null!=n)return n.cloneNode(!0);let s="";const i=e.length;i>0&&(s+=e[0]);for(let n=1;n<i;n++)s+=t[n-1],s+=e[n];const r=document.createElement("div");r.insertAdjacentHTML("afterbegin",s);const o=document.createDocumentFragment();for(;r.firstChild;)o.appendChild(r.firstChild);return l.set(e,o),o.cloneNode(!0)}class c extends HTMLElement{constructor(){super(),this.waiting=!1,this._key={altKey:!1,ctrlKey:!1,key:"",metaKey:!1,shiftKey:!1};const e=this.attachShadow({mode:"open"});e.appendChild(a`
            <style>
                .wrapper {
                    display: inline-block;
                    padding: 0.8em;
                }
            </style>
            <button class='wrapper'>
                <span class='key-text'></span>
            </button>
        `),this.wrapper=e.querySelector(".wrapper"),this.keyText=e.querySelector(".key-text"),this.initEvent()}static get observedAttributes(){return["label"]}attributeChangedCallback(e,t,n){"label"===e&&this.waiting&&(this.keyText.textContent=n)}initEvent(){this.addEventListener("click",e=>{if(this.waiting)return;this.waiting=!0,this.keyText.textContent=this.label;const t=e=>{if(["Alt","Control","Meta","Shift"].includes(e.key))return;this.waiting=!1,e.preventDefault();const n=function(e){const t={};return i(e,t),t}(e),s=this.dispatchEvent(new CustomEvent("key-change",{bubbles:!0,cancelable:!0,composed:!0,detail:{key:n,keyid:this.getAttribute("keyid")}}));this.key=s?n:this.key,this.ownerDocument.removeEventListener("keydown",t,!1)};this.ownerDocument.addEventListener("keydown",t,!1)},!1)}get key(){return this._key}set key(e){this._key=Object.assign({},e),this.waiting||(this.keyText.textContent=function({key:e,shiftKey:t,ctrlKey:n,altKey:s,metaKey:i}){let r="";return i&&(r+="Meta+"),n&&(r+="Ctrl+"),s&&(r+="Alt+"),t&&(r+="Shift+"),r+=" "===e?"Space":e}(e))}get label(){return this.getAttribute("label")||""}set label(e){this.setAttribute("label",e)}}class h extends HTMLElement{constructor(){super(),this.spec=[];const e=this.attachShadow({mode:"open"});e.appendChild(a`
            <table class='table'>
            </table>
        `),this.table=e.querySelector(".table")}static get observedAttributes(){return["label"]}attributeChangedCallback(e,n,s){if("label"===e)for(const e of Array.from(this.table.querySelectorAll(t)))e.label=s}setSpec(e){this.spec=e.map(({id:e,name:t})=>({id:e,name:t}));const t=this.table,n=this.getAttribute("label")||"";for(;t.rows.length>0;)t.deleteRow(0);for(const{id:e,name:s}of this.spec){const i=t.insertRow();i.insertCell().textContent=s;const r=i.insertCell(),o=new c;o.setAttribute("keyid",e),o.label=n,r.appendChild(o)}}setKey(e,n){const s=this.table.querySelector(`${t}[keyid="${CSS.escape(e)}"]`);if(null==s)throw new Error(`Key id "${e}" is not known.`);s.key=n}get label(){return this.getAttribute("label")||""}set label(e){this.setAttribute("label",e)}}class u extends HTMLElement{constructor(){super(),this.spec=[],this.store=null;const e=this.attachShadow({mode:"open"});this.table=new h,this.table.label=this.label,e.appendChild(this.table),this.addEventListener("key-change",e=>{const{keyid:t,key:n}=e.detail;null!=t&&null!=this.store&&this.store.set(t,n).catch(e=>console.error(e))},!1)}static get observedAttributes(){return["label"]}connect(e,t){return this.store=e,this.spec=t,this.table.setSpec(t),this.loadKeySetting()}attributeChangedCallback(e,t,n){"label"===e&&(this.table.label=n)}loadKeySetting(){return o(this.store,this.spec).then(e=>{for(const t of Object.keys(e))this.table.setKey(t,e[t])})}get label(){return this.getAttribute("label")||""}set label(e){this.setAttribute("label",e)}}let d=!1;class y{constructor(e){this.prefix=e}get(e){return new Promise((t,n)=>{chrome.storage.sync.get(e,e=>{null==e?n(chrome.runtime.lastError):t(e)})})}set(e,t){return new Promise(n=>{chrome.storage.sync.set({[e]:t},n)})}listen(e){const t=(t,n)=>{if("sync"===n)for(const n of Object.keys(t)){const s=t[n].newValue||null;e(n,s)}};chrome.storage.onChanged.addListener(t);return()=>chrome.storage.onChanged.removeListener(t)}}class f{constructor(e){this.prefix=e}get(e){const t={};for(const n of e){const e=localStorage.getItem(this.prefixedKey(n));null!=e&&(t[n]=JSON.parse(e))}return Promise.resolve(t)}set(e,t){return localStorage.setItem(this.prefixedKey(e),JSON.stringify(t)),Promise.resolve()}listen(e){const t=t=>{if(null!=t.key&&t.key.startsWith(`${this.prefix}-`)){const n=t.key.slice(this.prefix.length+1);try{const s=null!=t.newValue?JSON.parse(t.newValue):null;e(n,s)}catch(t){console.error(t)}}};window.addEventListener("storage",t,!1);return()=>window.removeEventListener("storage",t,!1)}prefixedKey(e){return`${this.prefix}-${e}`}}function b(e,t){if("TEXTAREA"===(n=t).tagName||"INPUT"===n.tagName&&"number"==typeof n.selectionStart){const{selectionStart:n,selectionEnd:s,value:i}=t;if(null!=n&&("insert-anywhere"===e||n===s&&s===i.length)){!function(e,t,n,s,i){e.setRangeText(t,n,s,i)}(t,"█",n,s,"end")}}else if(t.contentEditable){const n=window.getSelection().getRangeAt(0);if(null==n)return;if("insert-anywhere"===e||function(e,t){if(!e.collapsed)return!1;t.normalize();const n=new Range;n.selectNodeContents(t);let s=e.endContainer,i=e.endOffset;if(!n.isPointInRange(s,i))return!1;for(;s!==t;){if(!p(s,i))return!1;[s,i]=m(s,i)}return p(s,i)}(n,t)){const t=document.createTextNode("█");"insert-anywhere"===e&&n.deleteContents(),n.insertNode(t),n.collapse(!1)}}var n}function p(e,t){if(e.nodeType===Node.TEXT_NODE){const n=e.nodeValue.search(/[\r\n]+$/);return n>=0&&(e.splitText(n).remove(),t=e.nodeValue.length),e.nodeValue.length<=t}{const n=e.childNodes;for(const e=n.length;t<e;t++)if(!g(n[t]))return!1;return!0}}function m(e,t){const n=e.parentNode;if(null==n)throw new Error("Parent node does not exist");return[n,(s=n,i=e,[].indexOf.call(s.childNodes,i)+1)];var s,i}function g(e){return e.nodeType===Node.TEXT_NODE?/^[\r\n]*$/.test(e.nodeValue):"BR"===e.nodeName}const k="undefined"!=typeof chrome&&null!=chrome.i18n;const w=[{default:{key:"ArrowRight",shiftKey:!0},id:"insert-last",name:k?chrome.i18n.getMessage("insert_last"):"█を入力（入力欄の終端のみ）"},{default:{ctrlKey:!0,key:"L",shiftKey:!0},id:"insert-anywhere",name:k?chrome.i18n.getMessage("insert_anywhere"):"█を入力"}];function K(){return k?new y("chrome-xxxx"):new f("chrome-xxxx")}var x=Object.freeze({initOptionsPage:function(){d||(customElements.define(t,c),customElements.define(n,h),customElements.define(s,u),d=!0)},spec:w,initStore:K});const v=new class extends EventTarget{constructor(e,t){super(),this.store=e,this.spec=t,this.keys={},this.unlistenFunction=null,this.keyDest={altKey:!1,ctrlKey:!1,key:"",metaKey:!1,shiftKey:!1},this.keydownListener=this.keydownListener.bind(this)}listen(){return o(this.store,this.spec).then(e=>{this.keys=e,document.addEventListener("keydown",this.keydownListener,!1),this.unlistenFunction=this.store.listen((e,t)=>{if(null!=t)this.keys[e]=t;else{const t=this.spec.find(({id:t})=>t===e);this.keys[e]=r(null!=t&&t.default||{})}})})}unlisten(){document.removeEventListener("keydown",this.keydownListener,!1),null!=this.unlistenFunction&&(this.unlistenFunction(),this.unlistenFunction=null)}getShortcutKey(e){i(e,this.keyDest);for(const e in this.keys)if(t=this.keys[e],n=this.keyDest,t.altKey===n.altKey&&t.ctrlKey===n.ctrlKey&&t.key===n.key&&t.metaKey===n.metaKey&&t.shiftKey===n.shiftKey)return e;var t,n;return null}keydownListener(e){const t=this.getShortcutKey(e);if(null!=t){const e=new CustomEvent("key",{detail:t});this.dispatchEvent(e)}}}(K(),w);v.addEventListener("key",e=>{const t=document.activeElement;null!=t&&b(e.detail,t)});let E=!1;e.enable=function(){E||(E=!0,v.listen())},e.options=x,Object.defineProperty(e,"__esModule",{value:!0})});