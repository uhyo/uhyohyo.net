<!doctype html>
<html lang="ja-jp">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link href="/css/css.css" rel="stylesheet">
                  <link href="/css/js.css" rel="stylesheet">
                        <title>十二章第三回　History API — JavaScript初級者から中級者になろう &#x2014; uhyohyo.net</title>
        <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-46093038-1', 'auto');
ga('send', 'pageview');
    </script>
  </head>
  <body>
    <header>
      <h1>
        <a href="/">uhyohyo.net</a>
      </h1>
    </header>
    <main>
      
<article> 
  <h1>JavaScript初級者から中級者になろう</h1>
  <aside class="ad-javascript">
    <!-- Google Adsense -->
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:inline-block;width:180px;height:150px"
     data-ad-client="ca-pub-1080533149094679"
     data-ad-slot="7536196754"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </aside>
        <nav>
      <p>
        <a href="index.html" rel="bookmark">戻る</a>
                            |
          <a rel="prev" href="12_2.html">十二章第二回</a>
                          |
          <a rel="next" href="12_4.html">十二章第四回</a>
              </p>
    </nav>
    <h2>十二章第三回　History API</h2>
<p>次に紹介するのが<strong>HTML5 History API</strong>です。Historyとは<strong>履歴</strong>のことです。履歴関係のことは、historyという名前のオブジェクトから利用可能です。</p>

<h3>古典的な履歴操作</h3>
<p>実はこのhistory自体は昔からあって、いくつかメソッドを持っていました。</p>
        <pre><code><strong>history</strong>.<mark>back</mark>();</code></pre>
<p>例えばhistory.backメソッドは、いわゆる「戻る」ボタンと同じ動きです。</p>
<p>実際にやってみましょう。<input type="button" value="戻る" onclick="history.back()"></p>
<p>このボタンは次のようにできています。</p>
        <pre><code>&lt;input type="button" value="戻る" onclick="<mark>history.back()</mark>"&gt;</code></pre>
<p>逆に「進む」はhistory.forward()です。他に、「3個すすむ」とか「2個戻る」とかを汎用的に表現するhistory.goがあります。これは引数を取って、使いかたはこうです。</p>
<pre><code>history.go(<mark>3</mark>);	//3個すすむ
history.go(<mark>-2</mark>);	//-2個戻る</code></pre>
<p>このように、正の数値は進む、負の数値は戻るを表す数値を引数としてとります。</p>

<p>以上が、昔からある古典的な履歴操作です。次に、HTML5で加わった機能を説明します。</p>

<h3>履歴の追加</h3>
<p>HTML5での画期的な新機能は何かというと、<strong>履歴の追加</strong>です。<strong>勝手に自分で履歴を追加できる</strong>のです。</p>
<p>例えば、<input type="button" value="このボタン" onclick="history.pushState(null,'テスト','/javascript/testtest')">を押してみましょう。</p>
<p>押すと、実際にはページを移動していないのに、上のURLが「http://uhyohyo.net/javascript/testtest」というように変わったと思います。もちろん、実際にそんなURLを開いても何もありません。</p>
<p>さらに、そこからブラウザで「戻る」をやってみましょう。またもページが変わらずに、URLがもとのように戻ったと思います。つまり、これが意味するのは、このボタンによって、実際にページが変わったわけではないけれども履歴が追加されたということです。「進む」を押してみるとまたURLが変わるはずです。</p>
<p>それでは、その方法を紹介します。使うのは、<dfn>history.pushState</dfn>メソッドです。</p>
        <pre><code>history.<strong>pushState</strong>(null, null, "/javascript/testtest");</code></pre>
<p>今回用いたコードはこれです。3つの引数があることがわかりますね。ところで、nullというのは<a href="2_14.html">二章第十四回</a>でも紹介したように「何もない」ことを表すのでした。つまり、今回第一・第二引数としては特に何も渡したくないということです。第三引数が、変わるURLだということが分かると思います。</p>
<p>実は<strong>第三引数だけは省略可能</strong>であり、省略した場合は履歴だけがひっそりと追加されてURLは変わりません。</p>
<p>では第一引数と第二引数は何かというと、第一引数は<strong>state</strong>であり、これは<strong>その履歴と関連付けられた情報</strong>です。この情報をプログラムから利用したりしてみるわけです（後述）。ただ、今回は特に何もないのでnullにしてあります。</p>
<p>第二引数は<strong>タイトル</strong>です。これを指定してやると、URLだけでなくページのタイトルも変わることでしょう（ただし、2012/02/24現在で対応しているブラウザはありませんでした）。</p>

<p>ちなみに、「履歴を追加」ではなく「現在の履歴を上書き」してしまう、<dfn>history.replaceState</dfn>もあります。使い方はpushStateと同じです。</p>

<h3>履歴の活用</h3>
<p>さて、これで新しい履歴を追加する方法が分かりました。ちなみに、追加した履歴を消す方法はありません。</p>
<p>ところで、実際にページが移動するわけでもない履歴を追加して何の役に立つのでしょうか。</p>
<p>というのも、実は<strong>履歴移動を検知できる</strong>のです。この機能と組み合わせて利用するといいでしょう。</p>
<p>それは、<dfn>popstateイベント</dfn>です。これは、履歴を移動したら発生するイベントです。ただし、別のページへ行ってしまう場合は発生しません。今回のように、追加された履歴の間で移動する場合に発生してくれます。</p>
<p>popstateイベントはどこで発生するかというと、実はdocumentなどではなく<strong>window</strong>です。すなわち、こうです。</p>
<pre><code><mark>window</mark>.addEventListener(<mark>'popstate'</mark>,function(ev){
},false);
        </code></pre>
<p>しかし、「履歴を移動した」だけでは情報が足りません。そこで役に立つのがさっきの<strong>state</strong>です。実は、その履歴に関連付けられた情報はイベントオブジェクトの<strong>stateプロパティ</strong>に入っています。つまり今回の場合はev.stateですね。これを用いればどういう履歴かを判別できるわけです。</p>
<p>さて、それではこれらを活用して具体的に何ができるかを見ていきたいと思いますが、前回に続きサンプルを提示したいと思います。</p>
<p>今回作ってみるのは<strong>タブ</strong>を用いたページです。タブを選択すると内容が切り替わるというやつで、まずはHistory APIを使っていない土台の<a href="12_3_sample.html">サンプル</a>を見てください。上に3つリストがあって、クリックするとタブA,タブB,タブCが切り替わります。ちなみに、<a href="http://uhyohyo.sakura.tv/html/6_10.html">WAI-ARIA</a>を使っていますが、HTML要素に情報を関連付けるくらいにここでは抑えておけばいいでしょう。</p>
<p>それではここに、History APIを組み込んでみましょう。「タブを開いた」ということを履歴に追加して、「戻る」ボタンなどを使って履歴を移動するともとのタブが開けばいいのです。</p>
<p>これを組み込んだのが次の<a href="12_3_sample2.html">サンプル2</a>です。</p>
<p>タブを切り替えるとhistory.pushStateで履歴を追加します。その際、どのタブを開いたかはstateに入れることにしています。</p>
<p>このように、やはりクリックして何かが切り替わると、「戻る」などが使えるようになるのが自然です。それを実現するのがこのHistory APIです。</p>

<h3>location</h3>
<p>ところで、さらに手軽なのが<strong>ハッシュ</strong>です。ハッシュとは、</p>
        <pre><code>http://uhyohyo.net/index.html<mark>#abc</mark></code></pre>
<p>というような、「#」以降の部分です。これは一般的にページ名には含まれず、あるページ内での位置を表すなどするのでした。</p>
<p>JavaScriptでは、このハッシュを用いた操作をすることができます。それには、<dfn>location</dfn>というオブジェクトを使います。</p>
<p>locationもわりと昔からあり、<strong>URL</strong>を扱うためのものです。例えば、</p>
        <pre><code>location.<mark>href</mark></code></pre>
<p>で現在のURLを取得できます。さらに、このlocation.hrefに代入すると、そのページへ移動することができます。</p>

<p>ここで、ハッシュの部分だけを変更するには、location.hashを使います。例えば先程の例だと、location.hashには"#abc"と入っています。これに代入して変更すると、pushState同様に<strong>URLが変わります</strong>。しかも、<strong>ちゃんと履歴にも入ります</strong>。履歴に入るということは、ページ移動しているわけでもありませんので、popStateが使えるということです。</p>
<p>さっきのタブの例を、pushStateではなくlocation.hashを用いるように変更したのが<a href="12_3_sample3.html">サンプル3</a>です。</p>
<p>これは、pushStateの部分がlocation.hashへの代入になり、popStateイベントのほうもlocation.hashを調べています。</p>
<p>ここで注目すべきことは、<strong>popStateが呼び出された時点でlocationのURL情報は履歴移動後のものになっている</strong>ということです。ですから、例えばpushStateの第三引数にURLを指定した場合、location.hrefを調べることでURLをもとにした処理ができます。</p>

<h3>hashchangeイベント</h3>
<p>ところで、popstateと似たイベントとして、<strong>ハッシュだけが変わった場合</strong>に発生する<strong>hashchangeイベント</strong>があります。つまり、pushStateの第三引数によってURLも変わってしまった場合の履歴移動などでは発生しないイベントということです。</p>
<p>hashchangeイベントのイベントオブジェクトには<dfn>oldURL</dfn>と<dfn>newURL</dfn>という2つのプロパティがあり、移動元・移動後のURLを両方得ることができます。ただし、先程述べたとおり、ハッシュ以外は変わっていません。</p>
<p>ということで、最後に、popstateの代わりにこのhashchangeイベントを利用した<a href="12_3_sample4.html">サンプル4</a>を提示します。今回は、このoldURL・newURLは特に使う必要もないので使っていません。popstateのときと同様にlocation.hashを参照しています。</p>
<p>特筆すべきは、さっきのサンプル3では、location.hashに代入するときにopenTab関数を呼び出していたのに、サンプル4ではそれが消えているということです。</p>
<p>これはなぜかというと、hashchangeイベントが発生するのは「ハッシュが変わった場合」ですので、履歴移動により変わった場合はもちろんのこと、実は「JavaScript側によって変えられた場合」にも呼ばれるのです。ですから、location.hashに代入してハッシュが変わったので、その時点でhashchangeイベントが呼ばれているのです。</p>
<p>このようにhashchangeイベントを適切に使うと、今回の場合はopenTabを呼び出す箇所が一回だけに減るなど、すっきりしたコードが書けますので、うまく使い分けましょう。</p>

<h3>locationのまとめ</h3>
<p>今回ちらりと紹介したlocationオブジェクトについて以下にまとめます。</p>
<pre><code>
//プロパティ（すべて代入して変更可能です）
location.<mark>href</mark>;		//例: "<mark>http://uhyohyo.net/javascript/12_3.html?key=value#abc</mark>"
location.<mark>protocol</mark>;	//例: "<mark>http:</mark>"
location.<mark>host</mark>;		//例: "<mark>uhyohyo.net</mark>"
location.<mark>hostname</mark>;		//例: "<mark>uhyohyo.net</mark>"
location.<mark>port</mark>;		//例: ""
location.<mark>pathname</mark>;	//例: "<mark>/javascript/12_3.html</mark>"
location.<mark>search</mark>;	//例: "<mark>?key=value</mark>"
location.<mark>hash</mark>;		//例: "<mark>#abc</mark>"
        </code></pre>
<p>protocolは、「:」まで入っていることに注意してください。また、portは、通信に使用するポートです。HTTP通信は普通80で省略されます。普通でないポート（例：http://example.com:8080/ ）というときには、文字列で"8080"などと入ります。</p>
<p>hostとhostnameの違いは、このポートまで含めるかどうかです。hostnameは含めませんが、hostは含めます。</p>

<p>また、locationは<dfn>location.assign</dfn>というメソッドがあります。これは引数をひとつとってそのURLへ移動するメソッドで、location.hrefに直接代入するのとあまり変わりません。</p>
<p>また、<dfn>location.replace</dfn>というメソッドがあって、これはassignと同様の使い方ですが<strong>現在のページの履歴情報を上書きする</strong>もので、これを使ってページを移動すると「戻る」を押しても移動前が履歴に残っておらず、さらにその一つ前に飛ぶことになります。</p>
<p>また、<dfn>location.reload</dfn>は引数なしのメソッドで、現在のページを「更新」します。</p>

        <nav>
      <p>
        <a href="index.html" rel="bookmark">戻る</a>
                            |
          <a rel="prev" href="12_2.html">十二章第二回</a>
                          |
          <a rel="next" href="12_4.html">十二章第四回</a>
              </p>
    </nav>
  </article>

    </main>
  </body>
</html>
    
