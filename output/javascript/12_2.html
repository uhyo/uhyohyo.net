<!doctype html>
<html lang="ja-jp">
  <head>
    <meta charset="UTF-8">
    <link href="/css/css.css" rel="stylesheet">
                  <link href="/css/js.css" rel="stylesheet">
                        <title>十二章第二回　フォーム — JavaScript初級者から中級者になろう &#x2014; uhyohyo.net</title>
      </head>
  <body>
    <header>
      <h1>
        <a href="/">uhyohyo.net</a>
      </h1>
    </header>
    <main>
      
<article> 
  <h1>JavaScript初級者から中級者になろう</h1>
  <aside class="ad-javascript">
    <!-- Google Adsense -->
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:inline-block;width:180px;height:150px"
     data-ad-client="ca-pub-1080533149094679"
     data-ad-slot="7536196754"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </aside>
        <nav>
      <p>
        <a href="index.html" rel="bookmark">戻る</a>
                            |
          <a rel="prev" href="12_1.html">十二章第一回</a>
                          |
          <a rel="next" href="12_3.html">十二章第三回</a>
              </p>
    </nav>
    <h2>十二章第二回　フォーム</h2>
<p>HTML5になって、<strong>フォーム</strong>が大きく進化しました。そこで、それをJavaScriptで扱う方法を紹介します。どのように進化したかについては、ぜひ調べてみましょう（<a href="http://uhyohyo.sakura.tv/html/">HTML5講座</a>）。</p>

<h3>妥当性チェック</h3>
<p>HTML5のフォームには、<dfn>妥当性</dfn>（<span lang="en">validity</span>）というものがあります。これは要するに、入力内容が正しいかどうかということです。</p>
<p>そこでまず、あるフォームの妥当性をチェックするということをやってみましょう。</p>
<p>もちろん、各コントロール（inputとか）にそれぞれ妥当性というものがありますが、フォームが妥当であるということは、そのフォームに属する全てのコントロールが妥当である（入力内容が正しい）ということを表します。</p>
<p>入力内容が全て正しければそのフォームは送信してもよいということになるので、フォームが妥当であるとは、つまりそのフォームは送信できるということを表します。</p>

<p>それでは、JavaScriptでの方法ですが、簡単です。form要素のノードがあったら、そのノードの<dfn>checkValidity</dfn>というメソッド（引数なし）を呼び出すと、true（妥当である）かfalse（妥当でない）の真偽値を返します。</p>
<p><a href="12_2_sample.html">サンプル</a>を用意しました。</p>

<p>また、form要素だけでなく、input要素・select要素・button要素・fieldset要素などなどの各コントロールにも、妥当性チェックをするためのメソッドがあります。実は、こちらのほうがいろいろあって機能が豊富です。</p>
<p>まず、form要素と同様に<dfn>checkValidity</dfn>があります。これは、フォーム全体ではなく、その要素が妥当であるかどうかを判定できます。</p>
<p>ここで、これを利用したサンプルを用意してみました。「郵便番号」を入力するとそれに合わせた（今回は適当ですが）住所を表示するというサンプルです。</p>
<p><a href="12_2_sample2.html">サンプル</a></p>
<p>このサンプルでは、郵便番号のinput要素に<strong>oninput</strong>という属性があるのが分かります。onで始まるのはイベント属性で、今回の場合<dfn>input</dfn>というイベントです。これは、ユーザーによってinput要素の入力内容が変化した場合に起こるイベントで、今回のように、フォームの入力を監視する際に役立ちます。</p>
<p>HTML4時代には<strong>change</strong>というイベントもありましたが、これはinput要素からフォーカスが外れないと発生しないなど使いにくいものでしたので、このHTML5で新しく導入されたinputイベントを利用する機会のほうが多いでしょう。</p>
<p>それで、inputイベントが発生したときに何が起こるかというと、</p>
        <pre><code>inp(this)</code></pre>
<p>です。つまり、inpという関数を、引数thisで呼び出しているのです。イベント属性中でのthisは、この要素自身、つまりこのinputになります。inpという関数は下のほうで作ってあります。</p>
<p>関数inp内ではいろいろやっていますが、結局何をやっているかというと、「郵便番号」が正しく入力されていれば「住所」のところに住所を自動で入力するというだけです。</p>
<p>「郵便番号が正しく入力されている」とは、7桁の数字が入力されているということです。それをJavaScriptでどう表現するかというと、</p>
        <pre><code>input.checkValidity()</code></pre>
<p>だけです。つまり、このinputが妥当であるかどうか調べているだけです。</p>
<p>それでは「7桁の数字」の部分はどう表現しているかというと、実はinput要素の<strong>pattern属性</strong>に書いてあります。</p>
        <pre><code><strong>pattern</strong>="<mark>\d{7}</mark>"</code></pre>
<p>これは正規表現です。これは「数字7桁」を表していますね。HTML5では、このように、入力内容を正規表現を用いて指定できるのです。ただ、これは部分一致ではなく、全体で一致しないといけません。だから、「a1234567」のように余計な物があってはいけません。</p>
<p>pattern属性がある場合、この正規表現に入力内容がマッチする場合に、妥当であると判断されます。ですから、JavaScript側からはcheckValidity()で妥当性をチェックするだけでいいのです。</p>
<p>また、このinput要素を見ると、<strong>title属性</strong>があります。</p>
        <pre><code><mark>title</mark>="郵便番号は7桁の数字を入力して下さい。"</code></pre>
<p>このように、入力内容に制限があり複雑な場合、title属性を用いて説明するのがよいとされています。試しに正しく入力せずに「送信」を押して見ると、このメッセージが表示されると思います。</p>

<p>また、もっと詳細な情報を取得するために、<dfn>validity</dfn>というプロパティがあります。これは<strong>ValidityState</strong>という種類のオブジェクトです。</p>
<p>このオブジェクトはいくつかのプロパティを持ち、全て真偽値です。まず<dfn>valid</dfn>というプロパティは、その要素が妥当であるかどうかを返します。つまり、input要素のcheckValidity()と同じです。</p>
<p>そして、これがfalseだった場合、すなわち妥当ではないに、他のプロパティが活躍します。他のプロパティは全て、妥当ではない原因を表しています。以下に列挙します。</p>
<dl>
  <dt>valueMissing</dt>
  <dd>required属性（入力が必須）があるのに入力されていない場合true。</dd>
  <dt>typeMismatch</dt>
  <dd>type="email",type="url"の場合に、正しい書式でない場合にtrue。</dd>
  <dt>patternMismatch</dt>
  <dd>pattern属性で指定された条件に合っていない場合true。</dd>
  <dt>tooLong</dt>
  <dd>maxlength属性で決められた長さより長い場合にtrue。</dd>
  <dt>rangeUnderflow</dt>
  <dd>数値入力コントロールで、min属性よりも低い場合true。</dd>
  <dt>rangeOverflow</dt>
  <dd>数値入力コントロールでmax属性よりも高い場合true。</dd>
  <dt>stepMismatch</dt>
  <dd>数値入力コントロールで、strep属性で指定した単位とあわない場合true。</dd>
  <dt>customError</dt>
  <dd>独自エラー（後述）がある場合true。</dd>
</dl>
<p>これを用いて、妥当でない場合の細かい原因をチェックできるのです。</p>
<p>そして、<strong>独自エラー</strong>というものが出てきました。これは、HTMLが持つ機能だけでは表せないような複雑な条件である場合に、JavaScript側から「妥当である」とか「妥当でない」ということを決めてやることができるのです。</p>
<p>そのために使うメソッドが、input要素（など）が持つメソッド<dfn>setCustomValidity</dfn>です。これは、引数を1つ、<strong>エラーメッセージ</strong>を渡してやります。この関数を使用すると、その要素は妥当ではなくなります。</p>
<p>一度setCustomValidityで妥当でなくしたものが再び妥当になった場合には、setCustomValidityの引数を空文字列（""）にして呼び出すことで独自エラーを解除できます。</p>
<p>ということで、奮発してまたサンプルを用意しました。よくある感じで、パスワードを2回入力して一致しないとだめというやつです。</p>
<p><a href="12_2_sample3.html">サンプル</a></p>
<p>ここで、新しく<dfn>forminputイベント</dfn>というイベントが出てきているのが分かります。</p>
<p>これは、あるフォームの中でinputイベントが起きると、そのフォームのコントロール全てでforminputイベントが起こるというもので、すなわちそのフォームの変更を感知できます。</p>
<p>forminputイベントが起きたとき、関数inpを、そのフォーム（this.form）を引数として呼び出しています。関数inp内では、上のパスワード本体が正しく入力されているかチェックして、下のパスワードが上と一致する場合は妥当、一致しない場合は妥当でないとしていることがわかります。</p>
<p>試しに、上と下に違う内容を入力して「送信」を押すと「パスワードが一致しません。」というメッセージがでて送信できません。</p>
<p>ちなみに、formchangeというのも存在します。</p>
<p>ただし、2014年7月現在、forminputに対応しているのはOpera12だけです。メジャーなブラウザは対応する気がないのでしょうか。forminputを使わずに同じ動作を実現するには、パスワード入力フォームの両方にinputイベントを設定するのがよいでしょう。</p>

<p>最後に、input要素（など）が持つ<dfn>willValidate</dfn>プロパティを紹介します。これは真偽値で、その要素が<strong>制約バリデーション候補である</strong>（妥当か妥当でないかの判断の対象となる）かどうかです。というのも、たとえばtype属性が"hidden"とか、あるいは"button"とかの場合はユーザーが入力するものではないですから、妥当であるとか妥当でないとかいう概念が無いのです。</p>

<h3>数値入力とステップ</h3>
<p>数値入力のinput（type="number", type="range"）には、ステップというものがあります。例えば、</p>
        <pre><code>&lt;input type="number" min="0" step="10"&gt;</code></pre>
<p>というinput要素では、値として0,10,20,30,40,…を入力できます。</p>
<p>このようなinputに対して、<dfn>stepUp</dfn>,<dfn>stepDown</dfn>というメソッドが使用できます。引数は数値1つで、引数をnとすると、n段階だけ数値を上げ/下げるメソッドです。</p>
<p>例えば上のinputで数値が0のとき、stepUp(3)を実行すると30になります。30の状態からstepDown(2)を実行すると10になるでしょう。</p>

<h3>日付入力</h3>
<p>日付入力のinput要素において、サーバーへ送信されるのは文字列ですが、この文字列形式はそのままではJavaScriptで扱いにくいです。そこで、JavaScriptで扱いやすい形式で取得する方法があります。</p>
<p><dfn>valueAsDate</dfn>は、日付を<strong>Dateオブジェクト</strong>で取得できるプロパティです。Dateオブジェクト自体は昔からありました。</p>
<p>また<dfn>valueAsNumber</dfn>は、日付を1970年1月1日の0時からのミリ秒数を取得できます。</p>
        <nav>
      <p>
        <a href="index.html" rel="bookmark">戻る</a>
                            |
          <a rel="prev" href="12_1.html">十二章第一回</a>
                          |
          <a rel="next" href="12_3.html">十二章第三回</a>
              </p>
    </nav>
  </article>

    </main>
  </body>
</html>
    
